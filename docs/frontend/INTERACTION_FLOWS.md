# 交互流程

本文档以“用户动作 → 系统反馈”的形式描述核心流程。前端为单页应用，同一页面通过切换 `view-*` 显示不同模块。

## 1. 扫描任务流程（Scan）

### 1.1 进入与配置

用户动作：

- 点击顶栏“扫描”
- 填写“股票文件目录地址”（默认 `data`）
- 可选填写“股票代码”（支持逗号/空格/换行）
- 可选启用指数与实时开关

系统反馈：

- 显示 `view-scan` 的“基础参数”卡片与“扫描结果”表格
- 仅做前端输入收集；实际路径/文件有效性在后端校验

### 1.2 启动扫描

用户动作：

- 点击“开始扫描”（`#scan-btn`）

系统反馈：

- 发起 `POST /api/scan`（请求体包含目录、symbols、指数配置、策略参数等）
- 后端以 NDJSON 逐行返回进度/结果，前端：
  - 更新状态徽标（待开始/运行中/完成/失败）
  - 更新进度条与文本
  - 将每个标的的结果追加到表格 `#scan-results`

### 1.3 中断扫描

用户动作：

- 点击“中断”（`#scan-cancel-btn`）

系统反馈：

- 发起 `POST /api/scan/cancel`
- 前端将状态更新为“已取消/已停止”，并保持当前表格结果不清空

## 2. 参数预设与配置流程（Config）

### 2.1 加载预设列表

用户动作：

- 点击顶栏“配置”

系统反馈：

- 调用 `GET /api/presets` 获取预设列表，填充 `#preset-select`

### 2.2 应用预设到表单

用户动作：

- 在“选择模型”下拉框选择某个预设
- 点击“应用”

系统反馈：

- 调用 `POST /api/presets/load`（或先通过 `GET /api/presets/get` 拉取内容）
- 将返回的参数写入各 `cfg-*` 输入框
- 更新“当前应用”标签（`#active-preset-tag`）

### 2.3 保存预设

用户动作：

- 修改参数后输入“模型名称”
- 点击“保存”

系统反馈：

- 调用 `POST /api/presets/save`
- 成功后刷新列表，并在状态区提示成功/失败

### 2.4 参数解释查看

用户动作：

- 点击任意参数输入框

系统反馈：

- 前端从 `PARAM_DEFINITIONS` 中读取解释，展示在“参数说明”面板
- 点击“详细说明”打开更完整的说明弹窗（如存在）

## 3. 历史回测流程（Backtest）

### 3.1 启动回测

用户动作：

- 点击顶栏“回测”
- 填写数据目录、指数/日期区间等
- 点击“开始回测”（`#bt-btn`）

系统反馈：

- 调用 `POST /api/backtest`
- 前端显示运行状态、进度提示与结果表格逐步填充（或在完成后一次性渲染）
- 表格支持点击表头排序（依赖 `data-sort-key`）与筛选控件联动

### 3.2 查看详情

用户动作：

- 在回测结果行点击“查看详情”（通常为按钮/链接）

系统反馈：

- 调用 `GET /api/backtest/detail`（桥接到 `POST /api/backtest_detail`）
- 弹窗展示：交易明细、信号日志、参数分组、指标等

### 3.3 导出结果

用户动作：

- 点击“导出CSV(表格)”或下载全集（若启用）

系统反馈：

- 前端从当前内存中的结果构造 CSV 下载
- 若后端提供全集下载路径，则触发文件下载

## 4. 批量参数测试流程（Batch Param Test）

入口位于回测页内的“批量参数测试”卡片。

### 4.1 配置输入

用户动作：

- 在 `#pt-symbols` 输入要测试的股票列表
- 在 `#pt-param-sets` 输入参数组合（每行一个组合）
- 可选使用“快速选参”插入参数
- 可选使用“网格参数”生成组合并写入列表

系统反馈：

- 实时预览网格组合数量（`#pt-grid-preview`）
- 对空行/非法组合做提示（通常为 alert 或状态文案）

### 4.2 启动与任务追踪

用户动作：

- 点击“开始批量测试”（`#pt-run-btn`）

系统反馈：

- 调用 `POST /api/param_batch_test`，后端创建批量任务并返回任务 ID/聚合结果
- 前端：
  - 记录任务 ID 到 `localStorage`（用于刷新后恢复任务列表）
  - 在“批量任务”区域定时刷新状态（运行中/完成/取消/失败）

### 4.3 查看结果弹窗

用户动作：

- 打开批量测试结果弹窗（`#pt-modal`）

系统反馈：

- 展示按组合聚合后的指标表格（`#pt-results`）
- 支持排序与导出

## 5. 池子管理流程（Pool）

池子为本地保存，适合快速维护“关注列表”。

### 5.1 添加/更新

用户动作：

- 输入股票代码、预警价、备注
- 点击“添加/更新”

系统反馈：

- 写入 `localStorage`（最多 500 条）
- 立即刷新池子表格/列表

### 5.2 触发池子扫描/回测

用户动作：

- 点击“用池子扫描”或“用池子回测”

系统反馈：

- 将池子内标的自动填入对应模块输入框
- 切换到对应 view 并触发扫描/回测（实际计算仍走 API）

## 6. 交易日记流程（Journal）

交易日记为本地保存，强调纪律记录与复盘。

### 6.1 记录与保存

用户动作：

- 填写日期、股票代码、方向、依据、心理活动等
- 点击“保存”（`#journal-add`）

系统反馈：

- 写入 `localStorage` 并更新下方列表

### 6.2 清空

用户动作：

- 点击“清空表单”或“清空全部”

系统反馈：

- 清空表单输入或清空本地保存的全部记录

## 7. 数据同步与质量检查流程（Data）

### 7.1 同步一次

用户动作：

- 在数据页设置输出目录、区间、复权等
- 点击“同步一次”

系统反馈：

- 调用 `POST /api/data/sync`（通常为流式输出）
- 前端显示进度条与日志输出，可“停止读取（不中断后台请求）”

### 7.2 质量检查

用户动作：

- 配置检查参数（最小行数、缺口阈值、ST 过滤等）
- 启动检查

系统反馈：

- 调用 `POST /api/data/quality_check_stream` 并实时输出检查结果

## 8. 调试分析流程（Debug）

用户动作：

- 切换到“策略调试”
- 输入标的与数据路径，调整参数
- 点击分析按钮（页面内按钮）

系统反馈：

- 调用 `POST /api/debug/analyze`
- 展示 overview、交易列表、特征快照；支持 tab 切换与逐笔查看

## 9. 选股决策流程（Selector）

用户动作：

- 切换到“选股决策”
- 点击“开始选股”

系统反馈：

- 调用 `POST /api/selector`
- 渲染结果表格与关键指标

